#! /usr/bin/env bash

# System tests for postfix calculator (can test both C and asm versions)

# Check usage
if [ $# -ne 1 ]; then
	echo "Usage: ./sysTests.sh <exe name>"
	echo "  <exeName> should be './cPostfixCalc' or './asmPostfixCalc'"
	exit 1
fi

# Get the executable to test
exe="$1"

# Variables to keep track of test passed/attempted
numPassed=0
numAttempted=0

# Function testing that a postfix expression yields the expected result
expect() {
	local expected="$1"
	local expr="$2"

	if ./runTest.rb "$exe" "$expected" "$expr"; then
		numPassed=$(expr $numPassed + 1)
	fi
	numAttempted=$(expr $numAttempted + 1)
}

# Function testing that an invalid postfix expression yields an error
expect_error() {
	local expr="$1"

	if ./runTest.rb "$exe" "ERROR" "$expr"; then
		numPassed=$(expr $numPassed + 1)
	fi
	numAttempted=$(expr $numAttempted + 1)
}

#######################################################################
# Tests go here
#######################################################################

# Valid expresions
expect 5 '2 3 +'
expect 42 '6 7 *'
expect 42 '6 6 6 6 6 6 6 + + + + + +'
expect -836 '9 12 - 11 2 / + 15 15 15 - - / 9 10 - 5 3 - / 13 16 / 2 / * - 2 4 + / 3 17 / 2 * 1 19 + 20 7 * / + 6 12 / 20 3 + - 19 3 + 19 / + + 13 17 * 8 - 1 16 / 7 - / 6 5 5 + / 8 + - * -'
expect 139 '18 11 15 + 20 15 - 19 * 8 10 19 / * + + + 3 1 12 3 / + 19 14 * 13 1 * * + 12 12 * 3 1 * / 19 12 + 2 11 * + + * / +'
expect 50234505 '9 3 4 * 10 20 + - - 15 * 4 13 * 8 7 * + 5 16 * 17 8 * + + 8 4 20 + + 6 + * + 3 10 17 14 + 12 8 * * + - 8 13 * 6 8 + + 20 + 2 6 4 + 18 6 - * + * * -'
expect 0 '17 1 8 14 - 18 8 * + / 8 / 1 17 - 15 8 * + 13 * 16 - * *'
expect -1046016 '12 20 4 17 * / 16 2 + 20 2 - + - - 9 11 + 17 5 + - 18 6 / 15 + + 4 16 + 19 7 * / 6 5 / 2 + + * * 8 20 2 * + 5 + 6 4 * 8 12 * * 7 3 13 * - + * 20 2 / 14 15 - * 16 * 14 20 - 20 9 + - 3 * + / *'
expect 322 '5 10 + 1 - 11 12 + *'
expect 676 '8 4 17 19 / + 17 10 + 1 + * 10 12 + 12 12 + * 13 14 + 4 11 - + + + 8 + +'
expect 1909 '10 19 4 1 - 7 + 1 18 * 17 - * * * 9 +'
expect -43140 '9 2 / 16 8 6 + + 13 18 7 + - * 8 * + 15 *'
expect 0 '3 10 3 * 17 19 + + 18 / - 2 + 4 3 13 11 + - + 1 / 6 12 15 / 18 19 * + + 5 18 + / + +'
expect 167580 '19 14 13 8 * 4 / 3 12 16 - * + + 14 15 14 + - 8 18 / 3 18 + - * 17 3 + 4 + 17 20 + 14 6 + - / * * *'
expect 112243 '4 8 7 19 * 5 19 + + 11 1 / 13 5 * * * + 7 2 17 * 13 4 + + + 6 17 + 11 / 15 1 / 2 + * - - +'

# Valid expressions with whitespaces
expect 1 $'16 11 4 8 - / 7 - / \t \t 14 + 12 -'
expect 1471349 $'1 19               + 14 6 * * 8 - 14 2 + 17 14 + / 11 16 * 2 3 + * + * 13 15 2 + 7 + * 11 7 14 + 3 12 - * * / + 9 3 * 20 11 - * 15 2 - 2 19 - * / 2 - 14 + -'
expect 55 $'7 6 8 * + 9 17 + 7 3 16 *               - 11 1 + * 5 15 18 + + 9 2 + 3 7 + * * * / +'
expect 163692 $'17 20 14 / 12 + 11 13 - 8 4 * * * +              14 9 * 15 / 15 6 + 16 + / 15 + + 11 2 - 6 11 - - 3 12 + 3 * + 2 19 - 5 6 + + 17 6 5 + + - * 4 8 14 - 6 8 + + + 19 11 / 19 13 * 19 18 * - + + * +'
expect -10 $'19 17 * 7 + 20 14 7 / + / 13 15 - 18 1 - - 5 - * 19              3 / 16 12 * * 16 2 * 15 6 + * - 3 / + 19 /'
expect 9 $'16 7 \t\t            \t\t-'
expect -114744 $'\t 3 7 8 / + 13 * 19 16 16 + + / 7 - 11 14 13 + 12 16 - * 13 1 / 20 7 * + * - 16 3 7 - 9 19 * - 1 7 + 1 1 + * + + + *'
expect 529934 $'            \t\t\t\t 19 1 + 17 20 1\t\t\t\t * / 6 17 * 5 2 * / * - 6 18 - 20 18 / / 15 3 13 + * * 19 9 / 11 13 - - 7 2 + 9 19 * + + * - 6 -'
expect 33140 $'            \t\t\t\t 20 5 14 * 17 * 6 5 * 6 \t\t\t\t\t\t\t\t\t\t\t\t16 + + + 1 + 16 2 + 10 10 * 4 * 17 / * + *'
expect 2275 $'            \t\t\t\t 5 1 + 17 + 18 19 6 + * + 4 8 * 11 12 + / 17 / + \t\t\t\t\t\t\t\t7 * 16 18 10 12 / - + 4 3 15 + / 10 19 1 + + + * 16 + -'

# Invalid expressions

# Divide 0?
# expect_error '2 3 0 \ +'
# expect_error '0 6 7 * \'
# expect_error $'0 6 6 6 6 6 6 \t \t 6 \ + + + + + +'

# Insufficient tokens
expect_error '1 *'
expect_error '2 2'
expect_error '14 6 + 20 18 *  5 +  15 12 - 20 18 * - 11 5 / 4 10 * + + 1 * * 4 5 - 20 14 + + 5 * 20 4 + 19 1 * * 9 * / 2 15 14 * * 2 5 6 - + + 3 2 + 15 9 + * 18 / + * *'
expect_error '12 / 10 * 8 10  * +  * 9 16 + 2 2 + - * 16 11 - 4 2 / + 12 * + * 12 11 6 - 7 11 + - + 6 16 * 16 + 19 + / 20 20 16 + - 1 15 / 6 / + 4 + * *'
# expect_error '3 18 0 / 17 / 4  + 7  / + - + 15 15 2 * *** 14 * 7 17 + 2 * 8 3 2 + * + - 7 18 + 17 1 * / 16 8 - 17 9 / * + 5 7 * 11 + 9 1 * 19 / * * * +'
expect_error '17 + 10 19 / 6  / 11  13 1 * 2 4 * + 14 17 * 16 + + 3 15 6 * 1 14 + * * + * 9 12 6 + 13 - 18 12 + 17 1 * * * + 1 15 / 3 8 - * 18 3 * 14 5 + * + 12 11 / 3 17 + 5 2 - - + + + /'
expect_error '16 + 17 + 17 4  + 2  6 - 18 16 + - + * 18 + 14 17 + *'

# Bad tokens
expect_error '10 9 * s 4 20 4 * * / 7 17 * 6 13 * - 15 10 * 16 20 - / + + 18 12 + 4 4 - - 2 + 7 15 + 3 6 / + 1 5 + 13 17 * + + * - 17 14 5 * 14 - * 14 15 15 * 3 * + - 12 14 * 20 2 * + 1 - 11 9 * 5 7 * + 4 9 * 20 * + - * *'
expect_error '13 17 + 9 6 9 - d/ 8 16 16 / / + 14 6 + 4 9 / + 17 10 * + * 5 + +'
expect_error '6 20 + 12 5 3 ff+ + 11 - + 7 11 - 3 7 * * 17 * 6 3 + 6 15 / * 2 5 - + * * 12 16 + 9 + 12 7 + 10 * + 9 4 * 1 1 / / 18 15 + 17 6 + - * * 20 6 + + +'
expect_error '8 20 5 + 18 20 * / + \\17 9 2 18 - * / + 16 - 3 14 7 + 18 6 - * 1 11 + 6 * + 9 15 + 20 4 - * 17 2 + 3 4 * + * * - /'
expect_error '15 14 18 11 * * 20 20// 11 / * * 10 15 / 19 8 / * 3 * * * 11 4 20 * 7 3 * / / 9 17 + 4 - 8 + + 10 + -'
expect_error '5 15 11 + 8 8 + 4 3 * * 16 -asd * / 15 16 5 + * 3 * 18 14 + 18 9 + + 10 + * 10 - *'
expect_error '20 8 6 - 17 7 + * 18 10 * 5 4 *asdf + + + 9 / 6 13 + 17 4 * 5 5 + + + 1 9 / 10 * 18 1 + 1 14 / - * * 5 13 + 17 6 - * 20 9 + 3 11 * * / 17 10 * 15 18 15 - * * + * *'
expect_error '20 3 ff+'
expect_error '5 17 + 8114 saf * 4 3 / 18 18 * + + 19 3 * 20 5 + 17 6 * * * * 17 18 / 15 15 * / 1 7 + * 5 2 / 5 15 + - 7 + - - 19 15 16 + 6 1 * - 14 19 16 + * * 14 16 * 11 12 * / 6 17 + 10 19 * + / + / *'
expect_error '4 11 + 2 5 + asdf + 8 * 12 / 15 15 * 19 4 / / 10 17 - 6 14 / - + 3 12 + 5 * 9 - + * 19 20 2 / 1 8 - - 3 + 15 15 - 12 - 19 - - * -'

#######################################################################
# End of tests
#######################################################################

# Summarize results
echo "$numPassed/$numAttempted tests passed"
if [ $numPassed -eq $numAttempted ]; then
	exit 0
else
	exit 1
fi
